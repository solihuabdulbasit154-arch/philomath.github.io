<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PHILOMATH MINI MART - Professional System</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* ===== RESET & BASE ===== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        /* ===== LOGIN PAGE ===== */
        .login-page {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }

        .login-container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.2);
            padding: 40px;
            width: 100%;
            max-width: 400px;
            text-align: center;
        }

        .login-logo {
            margin-bottom: 30px;
        }

        .login-logo i {
            font-size: 3rem;
            color: #4f46e5;
            margin-bottom: 15px;
        }

        .login-logo h1 {
            font-size: 1.8rem;
            color: #334155;
            font-weight: 700;
        }

        .login-logo .store-name {
            color: #7c3aed;
            font-weight: 800;
            font-size: 2rem;
            margin-top: 5px;
        }

        .login-form .form-group {
            margin-bottom: 20px;
            text-align: left;
        }

        .login-form label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #475569;
        }

        .login-form input {
            width: 100%;
            padding: 14px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 1rem;
            font-family: 'Poppins', sans-serif;
        }

        .login-form input:focus {
            outline: none;
            border-color: #4f46e5;
        }

        .login-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(90deg, #4f46e5, #7c3aed);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            margin-top: 10px;
        }

        .login-links {
            margin-top: 20px;
            display: flex;
            justify-content: space-between;
            font-size: 0.9rem;
        }

        .login-links a {
            color: #4f46e5;
            text-decoration: none;
            cursor: pointer;
        }

        /* ===== MODAL ===== */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 400px;
            width: 100%;
        }

        /* ===== MAIN APP ===== */
        .app-container {
            display: none;
            min-height: 100vh;
            flex-direction: column;
        }

        /* ===== HEADER ===== */
        .app-header {
            background: linear-gradient(90deg, #4f46e5, #7c3aed);
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .header-logo {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .header-logo i {
            font-size: 2rem;
        }

        .header-logo h1 {
            font-size: 1.5rem;
            font-weight: 600;
        }

        .store-name-header {
            font-weight: 800;
            color: #fff;
            font-size: 1.6rem;
        }

        .header-stats {
            display: flex;
            gap: 20px;
            font-size: 0.9rem;
        }

        .header-stat {
            display: flex;
            align-items: center;
            gap: 8px;
            background: rgba(255,255,255,0.15);
            padding: 8px 15px;
            border-radius: 8px;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            background: rgba(255,255,255,0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
        }

        .logout-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 8px 15px;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* ===== TABS ===== */
        .tabs-nav {
            display: flex;
            background: #f8fafc;
            border-bottom: 2px solid #e2e8f0;
            overflow-x: auto;
            padding: 0 10px;
        }

        .tab-btn {
            padding: 18px 25px;
            border: none;
            background: none;
            font-size: 1rem;
            font-weight: 500;
            color: #64748b;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 12px;
            border-bottom: 3px solid transparent;
            white-space: nowrap;
        }

        .tab-btn.active {
            color: #4f46e5;
            border-bottom-color: #4f46e5;
            background: #f1f5f9;
        }

        /* ===== MAIN CONTENT ===== */
        .main-content {
            flex: 1;
            background: white;
            padding: 25px;
            overflow-y: auto;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* ===== DASHBOARD ===== */
        .dashboard-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 6px 15px rgba(0,0,0,0.08);
            border: 1px solid #e2e8f0;
        }

        .stat-card i {
            font-size: 2.5rem;
            margin-bottom: 15px;
            display: block;
        }

        .stat-card.revenue i { color: #10b981; }
        .stat-card.sales i { color: #3b82f6; }
        .stat-card.products i { color: #8b5cf6; }
        .stat-card.profit i { color: #f59e0b; }

        .stat-card h3 {
            font-size: 0.95rem;
            color: #64748b;
            margin-bottom: 8px;
        }

        .stat-card .value {
            font-size: 2.2rem;
            font-weight: 700;
            color: #334155;
            margin-bottom: 5px;
        }

        .naira-sign {
            font-size: 1.8rem;
            color: #065f46;
            font-weight: 600;
        }

        /* ===== PRODUCTS ===== */
        .products-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .product-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
            border: 1px solid #e2e8f0;
            position: relative;
        }

        .product-card.low-stock {
            border-left: 4px solid #ef4444;
        }

        .product-card .product-img {
            width: 100%;
            height: 140px;
            background: #f8fafc;
            border-radius: 10px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #94a3b8;
            font-size: 2rem;
        }

        .product-card h3 {
            font-size: 1.1rem;
            margin-bottom: 8px;
            color: #334155;
        }

        .product-card .product-price {
            font-size: 1.4rem;
            font-weight: 700;
            color: #4f46e5;
            margin: 10px 0;
        }

        .product-card .product-stock {
            font-size: 0.9rem;
            padding: 5px 12px;
            border-radius: 15px;
            display: inline-block;
            font-weight: 500;
        }

        .stock-ok {
            background: #d1fae5;
            color: #065f46;
        }

        .stock-low {
            background: #fee2e2;
            color: #991b1b;
        }

        /* ===== POS SYSTEM ===== */
        .pos-container {
            display: flex;
            flex-direction: column;
            gap: 25px;
        }

        @media (min-width: 992px) {
            .pos-container {
                flex-direction: row;
            }
        }

        .pos-products {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            gap: 15px;
            max-height: 600px;
            overflow-y: auto;
            padding: 10px;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
        }

        .pos-product {
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
        }

        .pos-product .product-img-small {
            width: 60px;
            height: 60px;
            background: #f8fafc;
            border-radius: 8px;
            margin: 0 auto 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #94a3b8;
            font-size: 1.5rem;
        }

        /* ===== CART ===== */
        .cart-container {
            background: #f8fafc;
            border-radius: 15px;
            padding: 25px;
            height: 100%;
        }

        .cart-items {
            min-height: 300px;
            max-height: 400px;
            overflow-y: auto;
            margin-bottom: 20px;
        }

        .cart-item {
            background: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        .cart-item-actions {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .quantity-btn {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: none;
            background: #e2e8f0;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: #475569;
            font-size: 1.1rem;
        }

        .cart-total {
            text-align: right;
            padding: 20px 0;
            border-top: 2px solid #e2e8f0;
            margin-top: 10px;
        }

        .cart-total h3 {
            font-size: 1.8rem;
            color: #4f46e5;
        }

        .cart-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 20px;
        }

        .cart-btn {
            padding: 15px;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .cart-btn-clear {
            background: #e2e8f0;
            color: #475569;
        }

        .cart-btn-checkout {
            background: linear-gradient(90deg, #10b981, #059669);
            color: white;
        }

        /* ===== RECEIPT ===== */
        .receipt-container {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-top: 25px;
            border: 2px dashed #10b981;
            display: none;
        }

        .receipt-container.active {
            display: block;
        }

        /* ===== SALES ===== */
        .sales-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
        }

        .sales-table th {
            background: #f8fafc;
            padding: 18px 15px;
            text-align: left;
            font-weight: 600;
            color: #475569;
            border-bottom: 2px solid #e2e8f0;
        }

        .sales-table td {
            padding: 15px;
            border-bottom: 1px solid #e2e8f0;
        }

        /* ===== SETTINGS ===== */
        .settings-section {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
            border: 1px solid #e2e8f0;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #475569;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1rem;
            font-family: 'Poppins', sans-serif;
        }

        /* ===== MESSAGES ===== */
        .message {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 18px 25px;
            border-radius: 12px;
            color: white;
            font-weight: 500;
            z-index: 1001;
            display: flex;
            align-items: center;
            gap: 12px;
            max-width: 400px;
        }

        .message.success {
            background: linear-gradient(90deg, #10b981, #059669);
        }

        .message.error {
            background: linear-gradient(90deg, #ef4444, #dc2626);
        }

        .message.info {
            background: linear-gradient(90deg, #3b82f6, #2563eb);
        }

        /* ===== RESPONSIVE ===== */
        @media (max-width: 768px) {
            .app-header {
                flex-direction: column;
                gap: 15px;
            }
            
            .header-stats {
                justify-content: center;
                flex-wrap: wrap;
            }
            
            .tab-btn {
                padding: 15px 20px;
                font-size: 0.95rem;
            }
            
            .dashboard-stats {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .pos-container {
                flex-direction: column;
            }
        }

        @media (max-width: 480px) {
            .dashboard-stats {
                grid-template-columns: 1fr;
            }
            
            .tab-btn {
                padding: 12px 15px;
                font-size: 0.9rem;
            }
            
            .products-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- ===== LOGIN PAGE ===== -->
    <div class="login-page" id="loginPage">
        <div class="login-container">
            <div class="login-logo">
                <i class="fas fa-store"></i>
                <h1>PHILOMATH</h1>
                <div class="store-name">MINI MART STORE</div>
                <p style="color: #64748b; margin-top: 10px;">Professional Management System</p>
            </div>
            
            <form class="login-form" id="loginForm">
                <div class="form-group">
                    <label><i class="fas fa-user"></i> Email or Phone Number</label>
                    <input type="text" id="loginUsername" placeholder="Enter email or phone" required>
                </div>
                
                <div class="form-group">
                    <label><i class="fas fa-lock"></i> Password</label>
                    <input type="password" id="loginPassword" placeholder="Enter password" required>
                </div>
                
                <button type="submit" class="login-btn">
                    <i class="fas fa-sign-in-alt"></i> Login to Dashboard
                </button>
                
                <div class="login-links">
                    <a onclick="showForgotPassword()">Forgot Password?</a>
                    <a onclick="showResetPassword()">Reset Password</a>
                </div>
            </form>
        </div>
    </div>

    <!-- ===== FORGOT PASSWORD MODAL ===== -->
    <div class="modal" id="forgotPasswordModal">
        <div class="modal-content">
            <h3><i class="fas fa-key"></i> Forgot Password</h3>
            <p style="margin: 15px 0; color: #64748b;">Enter your email or phone number.</p>
            
            <div class="form-group">
                <input type="text" id="forgotUsername" placeholder="Enter email or phone">
            </div>
            
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button onclick="closeForgotPassword()" style="padding: 12px 20px; background: #e2e8f0; border: none; border-radius: 8px; cursor: pointer; flex: 1;">Cancel</button>
                <button onclick="sendResetLink()" style="padding: 12px 20px; background: #4f46e5; color: white; border: none; border-radius: 8px; cursor: pointer; flex: 1;">Send Reset Link</button>
            </div>
        </div>
    </div>

    <!-- ===== RESET PASSWORD MODAL ===== -->
    <div class="modal" id="resetPasswordModal">
        <div class="modal-content">
            <h3><i class="fas fa-redo"></i> Reset Password</h3>
            <p style="margin: 15px 0; color: #64748b;">Enter your current and new password.</p>
            
            <div class="form-group">
                <input type="password" id="currentPassword" placeholder="Current password">
            </div>
            
            <div class="form-group">
                <input type="password" id="newPassword" placeholder="New password">
            </div>
            
            <div class="form-group">
                <input type="password" id="confirmPassword" placeholder="Confirm new password">
            </div>
            
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button onclick="closeResetPassword()" style="padding: 12px 20px; background: #e2e8f0; border: none; border-radius: 8px; cursor: pointer; flex: 1;">Cancel</button>
                <button onclick="resetPassword()" style="padding: 12px 20px; background: #4f46e5; color: white; border: none; border-radius: 8px; cursor: pointer; flex: 1;">Reset Password</button>
            </div>
        </div>
    </div>

    <!-- ===== MAIN APP ===== -->
    <div class="app-container" id="appContainer">
        <!-- Header -->
        <header class="app-header">
            <div class="header-left">
                <div class="header-logo">
                    <i class="fas fa-store"></i>
                    <h1><span class="store-name-header">PHILOMATH MINI MART</span></h1>
                </div>
                
                <div class="header-stats">
                    <div class="header-stat">
                        <i class="fas fa-boxes"></i>
                        <span>Products: <strong id="headerProducts">0</strong></span>
                    </div>
                    <div class="header-stat">
                        <i class="fas fa-chart-line"></i>
                        <span>Today: <strong id="headerToday">₦0</strong></span>
                    </div>
                    <div class="header-stat">
                        <i class="fas fa-exclamation-triangle"></i>
                        <span>Low Stock: <strong id="headerLowStock">0</strong></span>
                    </div>
                </div>
            </div>
            
            <div class="user-info">
                <div class="user-avatar">
                    <i class="fas fa-user-circle"></i>
                </div>
                <div>
                    <div style="font-weight: 600;" id="userName">Admin</div>
                    <div style="font-size: 0.85rem; opacity: 0.8;" id="userRole">Store Manager</div>
                </div>
                <button class="logout-btn" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </button>
            </div>
        </header>

        <!-- Tabs Navigation -->
        <nav class="tabs-nav">
            <button class="tab-btn active" onclick="switchTab('dashboard')">
                <i class="fas fa-tachometer-alt"></i> Dashboard
            </button>
            <button class="tab-btn" onclick="switchTab('products')">
                <i class="fas fa-box-open"></i> Products
            </button>
            <button class="tab-btn" onclick="switchTab('pos')">
                <i class="fas fa-cash-register"></i> POS System
            </button>
            <button class="tab-btn" onclick="switchTab('sales')">
                <i class="fas fa-chart-bar"></i> Sales History
            </button>
            <button class="tab-btn" onclick="switchTab('settings')">
                <i class="fas fa-cog"></i> Settings
            </button>
        </nav>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Dashboard Tab -->
            <section id="dashboard" class="tab-content active">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; flex-wrap: wrap; gap: 15px;">
                    <h2 style="color: #334155; font-size: 1.8rem; display: flex; align-items: center; gap: 12px;"><i class="fas fa-tachometer-alt"></i> Dashboard Overview</h2>
                    <div>
                        <button onclick="refreshDashboard()" style="padding: 12px 20px; background: #3b82f6; color: white; border: none; border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 8px;">
                            <i class="fas fa-sync-alt"></i> Refresh
                        </button>
                    </div>
                </div>
                
                <div class="dashboard-stats">
                    <div class="stat-card revenue">
                        <i class="fas fa-money-bill-wave"></i>
                        <h3>Total Revenue</h3>
                        <div class="value"><span class="naira-sign">₦</span><span id="totalRevenue">0</span></div>
                    </div>
                    
                    <div class="stat-card sales">
                        <i class="fas fa-shopping-cart"></i>
                        <h3>Total Sales</h3>
                        <div class="value" id="totalSales">0</div>
                    </div>
                    
                    <div class="stat-card products">
                        <i class="fas fa-box"></i>
                        <h3>Products in Stock</h3>
                        <div class="value" id="totalProducts">0</div>
                    </div>
                    
                    <div class="stat-card profit">
                        <i class="fas fa-chart-pie"></i>
                        <h3>Average Sale</h3>
                        <div class="value"><span class="naira-sign">₦</span><span id="avgSale">0</span></div>
                    </div>
                </div>
                
                <h3 style="margin: 30px 0 20px 0;"><i class="fas fa-boxes"></i> Recent Products</h3>
                <div class="products-grid" id="dashboardProducts">
                    <!-- Products will load here -->
                </div>
            </section>

            <!-- Products Tab -->
            <section id="products" class="tab-content">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; flex-wrap: wrap; gap: 15px;">
                    <h2 style="color: #334155; font-size: 1.8rem; display: flex; align-items: center; gap: 12px;"><i class="fas fa-box-open"></i> Product Inventory</h2>
                    <div>
                        <button onclick="exportProducts()" style="padding: 12px 20px; background: #3b82f6; color: white; border: none; border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 8px; margin-right: 10px;">
                            <i class="fas fa-download"></i> Export
                        </button>
                        <button onclick="showAddProduct()" style="padding: 12px 20px; background: #10b981; color: white; border: none; border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 8px;">
                            <i class="fas fa-plus"></i> Add Product
                        </button>
                    </div>
                </div>
                
                <div style="overflow-x: auto;">
                    <table class="sales-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Product</th>
                                <th>Category</th>
                                <th>Price</th>
                                <th>Stock</th>
                                <th>Sold</th>
                                <th>Revenue</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="productsTable">
                            <!-- Products will load here -->
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- POS System Tab -->
            <section id="pos" class="tab-content">
                <h2 style="color: #334155; margin-bottom: 25px; display: flex; align-items: center; gap: 12px;"><i class="fas fa-cash-register"></i> Point of Sale System</h2>
                
                <div class="pos-container">
                    <!-- Products Section -->
                    <div style="flex: 3;">
                        <div style="margin-bottom: 20px;">
                            <input type="text" id="posSearch" placeholder="Search products by name or category..." style="width: 100%; padding: 15px; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 1rem;">
                        </div>
                        
                        <div class="pos-products" id="posProductsList">
                            <!-- POS products will load here -->
                        </div>
                    </div>
                    
                    <!-- Cart Section -->
                    <div style="flex: 1; min-width: 350px;">
                        <div class="cart-container">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                                <h3 style="color: #334155; font-size: 1.4rem;"><i class="fas fa-shopping-cart"></i> Shopping Cart</h3>
                                <div style="color: #64748b; font-size: 0.9rem;">Items: <strong id="cartItemCount">0</strong></div>
                            </div>
                            
                            <div class="cart-items" id="cartItems">
                                <div style="text-align: center; padding: 40px; color: #94a3b8;">
                                    <i class="fas fa-shopping-cart" style="font-size: 3rem; opacity: 0.3; margin-bottom: 15px;"></i>
                                    <p>No items in cart</p>
                                    <p style="font-size: 0.9rem; margin-top: 10px;">Add products from the left</p>
                                </div>
                            </div>
                            
                            <div class="cart-total">
                                <h3>Total: <span class="naira-sign">₦</span><span id="cartTotal">0.00</span></h3>
                            </div>
                            
                            <div class="cart-actions">
                                <button class="cart-btn cart-btn-clear" onclick="clearCart()">
                                    <i class="fas fa-trash"></i> Clear Cart
                                </button>
                                <button class="cart-btn cart-btn-checkout" onclick="checkout()">
                                    <i class="fas fa-check"></i> Checkout
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Receipt Section -->
                <div class="receipt-container" id="receiptContainer">
                    <!-- Receipt will be generated here -->
                </div>
            </section>

            <!-- Sales History Tab -->
            <section id="sales" class="tab-content">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; flex-wrap: wrap; gap: 15px;">
                    <h2 style="color: #334155; font-size: 1.8rem; display: flex; align-items: center; gap: 12px;"><i class="fas fa-chart-bar"></i> Sales History</h2>
                    
                    <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                        <input type="date" id="startDate" style="padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px;">
                        <span>to</span>
                        <input type="date" id="endDate" style="padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px;">
                        <button onclick="filterSales()" style="padding: 10px 20px; background: #4f46e5; color: white; border: none; border-radius: 8px; cursor: pointer;">
                            <i class="fas fa-filter"></i> Filter
                        </button>
                        <button onclick="resetSalesFilter()" style="padding: 10px 20px; background: #e2e8f0; color: #475569; border: none; border-radius: 8px; cursor: pointer;">
                            <i class="fas fa-redo"></i> Reset
                        </button>
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 20px; margin-bottom: 30px;">
                    <div style="background: white; border-radius: 12px; padding: 20px; border: 1px solid #e2e8f0; text-align: center; border-top: 4px solid #10b981;">
                        <h4 style="font-size: 0.9rem; color: #64748b; margin-bottom: 10px;">Total Sales</h4>
                        <div style="font-size: 1.8rem; font-weight: 700; color: #334155;" id="filteredSalesCount">0</div>
                    </div>
                    <div style="background: white; border-radius: 12px; padding: 20px; border: 1px solid #e2e8f0; text-align: center; border-top: 4px solid #3b82f6;">
                        <h4 style="font-size: 0.9rem; color: #64748b; margin-bottom: 10px;">Total Revenue</h4>
                        <div style="font-size: 1.8rem; font-weight: 700; color: #334155;"><span class="naira-sign">₦</span><span id="filteredRevenue">0</span></div>
                    </div>
                    <div style="background: white; border-radius: 12px; padding: 20px; border: 1px solid #e2e8f0; text-align: center; border-top: 4px solid #8b5cf6;">
                        <h4 style="font-size: 0.9rem; color: #64748b; margin-bottom: 10px;">Average Sale</h4>
                        <div style="font-size: 1.8rem; font-weight: 700; color: #334155;"><span class="naira-sign">₦</span><span id="filteredAvg">0</span></div>
                    </div>
                    <div style="background: white; border-radius: 12px; padding: 20px; border: 1px solid #e2e8f0; text-align: center; border-top: 4px solid #f59e0b;">
                        <h4 style="font-size: 0.9rem; color: #64748b; margin-bottom: 10px;">Top Product</h4>
                        <div style="font-size: 1.8rem; font-weight: 700; color: #334155;" id="topProduct">-</div>
                    </div>
                </div>
                
                <div style="overflow-x: auto;">
                    <table class="sales-table">
                        <thead>
                            <tr>
                                <th>Receipt #</th>
                                <th>Date & Time</th>
                                <th>Items</th>
                                <th>Quantity</th>
                                <th>Total</th>
                                <th>Payment</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="salesTable">
                            <!-- Sales will load here -->
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Settings Tab -->
            <section id="settings" class="tab-content">
                <div style="max-width: 800px; margin: 0 auto;">
                    <h2 style="color: #334155; margin-bottom: 25px; display: flex; align-items: center; gap: 12px;"><i class="fas fa-cog"></i> System Settings</h2>
                    
                    <div class="settings-section">
                        <h3 style="color: #334155; margin-bottom: 20px; display: flex; align-items: center; gap: 10px;"><i class="fas fa-user-cog"></i> Account Settings</h3>
                        <form id="accountForm">
                            <div class="form-group">
                                <label>Store Name</label>
                                <input type="text" id="storeName" value="PHILOMATH MINI MART STORE">
                            </div>
                            
                            <div class="form-group">
                                <label>Store Address</label>
                                <input type="text" id="storeAddress" placeholder="Enter store address">
                            </div>
                            
                            <div class="form-group">
                                <label>Store Phone</label>
                                <input type="text" id="storePhone" placeholder="Enter store phone number">
                            </div>
                            
                            <div class="form-group">
                                <label>Currency</label>
                                <select id="storeCurrency">
                                    <option value="₦" selected>Naira (₦)</option>
                                    <option value="$">Dollar ($)</option>
                                    <option value="€">Euro (€)</option>
                                    <option value="£">Pound (£)</option>
                                </select>
                            </div>
                        </form>
                    </div>
                    
                    <div class="settings-section">
                        <h3 style="color: #334155; margin-bottom: 20px; display: flex; align-items: center; gap: 10px;"><i class="fas fa-receipt"></i> Receipt Settings</h3>
                        <form id="receiptForm">
                            <div class="form-group">
                                <label>Receipt Footer Message</label>
                                <input type="text" id="receiptFooter" value="Thank you for shopping with us! Visit again!">
                            </div>
                            
                            <div class="form-group">
                                <label>Receipt Tax Rate (%)</label>
                                <input type="number" id="taxRate" value="0" min="0" max="100">
                            </div>
                        </form>
                    </div>
                    
                    <div class="settings-section">
                        <h3 style="color: #334155; margin-bottom: 20px; display: flex; align-items: center; gap: 10px;"><i class="fas fa-database"></i> Data Management</h3>
                        <div style="display: flex; gap: 15px;">
                            <button onclick="exportAllData()" style="padding: 15px 25px; background: #3b82f6; color: white; border: none; border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 10px; flex: 1;">
                                <i class="fas fa-download"></i> Export All Data
                            </button>
                            <button onclick="backupData()" style="padding: 15px 25px; background: #10b981; color: white; border: none; border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 10px; flex: 1;">
                                <i class="fas fa-save"></i> Backup Now
                            </button>
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <script>
        // ===== STORAGE KEYS =====
        const STORAGE_KEYS = {
            USERS: 'philomath_users_v2',
            PRODUCTS: 'philomath_products_v2',
            SALES: 'philomath_sales_v2',
            CART: 'philomath_cart_v2',
            SETTINGS: 'philomath_settings_v2',
            SESSION: 'philomath_session_v2'
        };

        // ===== INITIAL DATA =====
        const INITIAL_USERS = [
            {
                id: 1,
                username: 'admin',
                email: 'admin@philomart.com',
                phone: '08123456789',
                password: 'admin123',
                name: 'Store Administrator',
                role: 'admin',
                createdAt: new Date().toISOString()
            }
        ];

        const INITIAL_PRODUCTS = [
            { id: 1, name: "Coca-Cola 500ml", price: 350, category: "Beverages", stock: 50, sold: 120 },
            { id: 2, name: "Lays Potato Chips", price: 500, category: "Snacks", stock: 30, sold: 85 },
            { id: 3, name: "Peak Milk 400g", price: 850, category: "Dairy", stock: 20, sold: 65 },
            { id: 4, name: "Fresh Bread", price: 450, category: "Bakery", stock: 25, sold: 90 },
            { id: 5, name: "Eggs (Crate)", price: 2200, category: "Dairy", stock: 40, sold: 110 },
            { id: 6, name: "Pure Water 75cl", price: 150, category: "Water", stock: 60, sold: 200 },
            { id: 7, name: "Cadbury Chocolate", price: 300, category: "Snacks", stock: 15, sold: 75 },
            { id: 8, name: "Closeup Toothpaste", price: 700, category: "Personal Care", stock: 18, sold: 45 },
            { id: 9, name: "Indomie Noodles", price: 250, category: "Food", stock: 45, sold: 150 },
            { id: 10, name: "Dano Milk 500ml", price: 550, category: "Dairy", stock: 22, sold: 60 }
        ];

        const INITIAL_SETTINGS = {
            storeName: "PHILOMATH MINI MART STORE",
            storeAddress: "123 Market Street, Lagos",
            storePhone: "0812 345 6789",
            currency: "₦",
            taxRate: 0,
            receiptFooter: "Thank you for shopping with us! Visit again!"
        };

        // ===== GLOBAL VARIABLES =====
        let users = [];
        let products = [];
        let sales = [];
        let cart = [];
        let settings = {};
        let currentUser = null;

        // ===== INITIALIZATION =====
        document.addEventListener('DOMContentLoaded', function() {
            initializeData();
            checkSession();
            setupDateFilters();
            
            // Login form submit
            document.getElementById('loginForm').addEventListener('submit', function(e) {
                e.preventDefault();
                login();
            });
        });

        function initializeData() {
            // Load or initialize users
            let savedUsers = localStorage.getItem(STORAGE_KEYS.USERS);
            if (!savedUsers) {
                localStorage.setItem(STORAGE_KEYS.USERS, JSON.stringify(INITIAL_USERS));
                users = INITIAL_USERS;
            } else {
                users = JSON.parse(savedUsers);
            }

            // Load or initialize products
            let savedProducts = localStorage.getItem(STORAGE_KEYS.PRODUCTS);
            if (!savedProducts) {
                localStorage.setItem(STORAGE_KEYS.PRODUCTS, JSON.stringify(INITIAL_PRODUCTS));
                products = INITIAL_PRODUCTS;
            } else {
                products = JSON.parse(savedProducts);
            }

            // Load sales
            let savedSales = localStorage.getItem(STORAGE_KEYS.SALES);
            if (savedSales) {
                sales = JSON.parse(savedSales);
            }

            // Load cart
            let savedCart = localStorage.getItem(STORAGE_KEYS.CART);
            if (savedCart) {
                cart = JSON.parse(savedCart);
            }

            // Load or initialize settings
            let savedSettings = localStorage.getItem(STORAGE_KEYS.SETTINGS);
            if (!savedSettings) {
                localStorage.setItem(STORAGE_KEYS.SETTINGS, JSON.stringify(INITIAL_SETTINGS));
                settings = INITIAL_SETTINGS;
            } else {
                settings = JSON.parse(savedSettings);
            }
        }

        function checkSession() {
            let session = localStorage.getItem(STORAGE_KEYS.SESSION);
            if (session) {
                try {
                    session = JSON.parse(session);
                    if (session.expires > Date.now()) {
                        currentUser = users.find(u => u.id === session.userId);
                        if (currentUser) {
                            showApp();
                            return;
                        }
                    }
                } catch (e) {
                    console.log('Session error:', e);
                }
            }
            showLogin();
        }

        // ===== AUTHENTICATION =====
        function login() {
            const username = document.getElementById('loginUsername').value.trim();
            const password = document.getElementById('loginPassword').value.trim();

            if (!username || !password) {
                showMessage('Please enter username and password', 'error');
                return;
            }

            // Find user
            const user = users.find(u => 
                u.email === username || 
                u.phone === username || 
                u.username === username
            );

            if (!user) {
                showMessage('User not found', 'error');
                return;
            }

            if (user.password !== password) {
                showMessage('Invalid password', 'error');
                return;
            }

            // Create session
            currentUser = user;
            const sessionData = {
                userId: user.id,
                expires: Date.now() + (24 * 60 * 60 * 1000)
            };
            localStorage.setItem(STORAGE_KEYS.SESSION, JSON.stringify(sessionData));

            // Update UI
            document.getElementById('userName').textContent = user.name;
            document.getElementById('userRole').textContent = user.role;

            // Clear form
            document.getElementById('loginUsername').value = '';
            document.getElementById('loginPassword').value = '';

            // Show app
            showApp();
            showMessage(`Welcome back, ${user.name}!`, 'success');
        }

        function logout() {
            currentUser = null;
            localStorage.removeItem(STORAGE_KEYS.SESSION);
            showLogin();
            showMessage('Logged out successfully', 'info');
        }

        function showForgotPassword() {
            document.getElementById('forgotPasswordModal').style.display = 'flex';
        }

        function closeForgotPassword() {
            document.getElementById('forgotPasswordModal').style.display = 'none';
        }

        function sendResetLink() {
            const username = document.getElementById('forgotUsername').value.trim();
            
            if (!username) {
                showMessage('Please enter your email or phone', 'error');
                return;
            }

            const user = users.find(u => u.email === username || u.phone === username);
            if (user) {
                showMessage(`Password reset link sent to ${username}`, 'success');
            } else {
                showMessage('User not found', 'error');
            }
            closeForgotPassword();
        }

        function showResetPassword() {
            document.getElementById('resetPasswordModal').style.display = 'flex';
        }

        function closeResetPassword() {
            document.getElementById('resetPasswordModal').style.display = 'none';
        }

        function resetPassword() {
            const current = document.getElementById('currentPassword').value;
            const newPass = document.getElementById('newPassword').value;
            const confirmPass = document.getElementById('confirmPassword').value;

            if (!current || !newPass || !confirmPass) {
                showMessage('Please fill all fields', 'error');
                return;
            }

            if (newPass !== confirmPass) {
                showMessage('New passwords do not match', 'error');
                return;
            }

            if (!currentUser || currentUser.password !== current) {
                showMessage('Current password is incorrect', 'error');
                return;
            }

            // Update password
            currentUser.password = newPass;
            localStorage.setItem(STORAGE_KEYS.USERS, JSON.stringify(users));

            showMessage('Password updated successfully', 'success');
            closeResetPassword();
            
            // Clear fields
            document.getElementById('currentPassword').value = '';
            document.getElementById('newPassword').value = '';
            document.getElementById('confirmPassword').value = '';
        }

        // ===== UI MANAGEMENT =====
        function showLogin() {
            document.getElementById('loginPage').style.display = 'flex';
            document.getElementById('appContainer').style.display = 'none';
        }

        function showApp() {
            document.getElementById('loginPage').style.display = 'none';
            document.getElementById('appContainer').style.display = 'flex';
            loadDashboard();
            updateHeaderStats();
        }

        function switchTab(tabName) {
            // Update active tab
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.currentTarget.classList.add('active');

            // Show active content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(tabName).classList.add('active');

            // Load content
            if (tabName === 'dashboard') {
                loadDashboard();
            } else if (tabName === 'products') {
                loadProductsTable();
            } else if (tabName === 'pos') {
                loadPosProducts();
                updateCartDisplay();
            } else if (tabName === 'sales') {
                loadSales();
            } else if (tabName === 'settings') {
                loadSettings();
            }
        }

        function setupDateFilters() {
            const today = new Date();
            const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
            const lastDay = new Date(today.getFullYear(), today.getMonth() + 1, 0);
            
            document.getElementById('startDate').valueAsDate = firstDay;
            document.getElementById('endDate').valueAsDate = lastDay;
        }

        // ===== DASHBOARD =====
        function loadDashboard() {
            // Update stats
            const totalRevenue = sales.reduce((sum, sale) => sum + sale.total, 0);
            const avgSale = sales.length > 0 ? Math.round(totalRevenue / sales.length) : 0;
            const lowStockCount = products.filter(p => p.stock < 10).length;
            
            document.getElementById('totalRevenue').textContent = formatNumber(totalRevenue);
            document.getElementById('totalSales').textContent = sales.length;
            document.getElementById('totalProducts').textContent = products.length;
            document.getElementById('avgSale').textContent = formatNumber(avgSale);

            // Load products
            const productsGrid = document.getElementById('dashboardProducts');
            productsGrid.innerHTML = '';
            
            products.slice(0, 8).forEach(product => {
                const productCard = document.createElement('div');
                productCard.className = `product-card ${product.stock < 10 ? 'low-stock' : ''}`;
                productCard.innerHTML = `
                    <div class="product-img">
                        <i class="fas fa-box"></i>
                    </div>
                    <h3>${product.name}</h3>
                    <div style="color: #64748b; font-size: 0.85rem; margin-bottom: 8px; background: #f8fafc; padding: 4px 10px; border-radius: 12px; display: inline-block;">${product.category}</div>
                    <div class="product-price">${settings.currency}${product.price.toLocaleString()}</div>
                    <div class="product-stock ${product.stock < 10 ? 'stock-low' : 'stock-ok'}">
                        <i class="fas ${product.stock < 10 ? 'fa-exclamation-triangle' : 'fa-check'}"></i>
                        ${product.stock} in stock
                    </div>
                    ${product.sold ? `<div style="font-size:0.85rem; color:#64748b; margin-top:10px;">Sold: ${product.sold}</div>` : ''}
                `;
                productsGrid.appendChild(productCard);
            });
        }

        function refreshDashboard() {
            loadDashboard();
            updateHeaderStats();
            showMessage('Dashboard refreshed', 'success');
        }

        function updateHeaderStats() {
            const today = new Date().toDateString();
            const todaySales = sales.filter(sale => {
                return new Date(sale.date).toDateString() === today;
            });
            const todayRevenue = todaySales.reduce((sum, sale) => sum + sale.total, 0);
            const lowStockCount = products.filter(p => p.stock < 10).length;
            
            document.getElementById('headerProducts').textContent = products.length;
            document.getElementById('headerToday').textContent = formatNumber(todayRevenue);
            document.getElementById('headerLowStock').textContent = lowStockCount;
        }

        // ===== PRODUCT MANAGEMENT =====
        function loadProductsTable() {
            const tableBody = document.getElementById('productsTable');
            tableBody.innerHTML = '';
            
            products.forEach(product => {
                const revenue = (product.sold || 0) * product.price;
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${product.id}</td>
                    <td><strong>${product.name}</strong></td>
                    <td><span style="background:#f1f5f9; padding:4px 10px; border-radius:12px; font-size:0.85rem;">${product.category}</span></td>
                    <td><strong>${settings.currency}${product.price.toLocaleString()}</strong></td>
                    <td>
                        <span class="product-stock ${product.stock < 10 ? 'stock-low' : 'stock-ok'}" style="font-size:0.85rem;">
                            ${product.stock}
                        </span>
                    </td>
                    <td>${product.sold || 0}</td>
                    <td><strong>${settings.currency}${revenue.toLocaleString()}</strong></td>
                    <td>
                        ${product.stock < 10 ? 
                            '<span style="color:#ef4444; font-weight:500;"><i class="fas fa-exclamation-circle"></i> Low</span>' : 
                            '<span style="color:#10b981; font-weight:500;"><i class="fas fa-check-circle"></i> OK</span>'
                        }
                    </td>
                    <td>
                        <button onclick="editProduct(${product.id})" style="padding:6px 12px; background:#3b82f6; color:white; border:none; border-radius:6px; cursor:pointer; margin-right:5px;">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button onclick="deleteProduct(${product.id})" style="padding:6px 12px; background:#ef4444; color:white; border:none; border-radius:6px; cursor:pointer;">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }

        function showAddProduct() {
            const name = prompt('Product name:');
            if (!name) return;
            
            const category = prompt('Category:', 'Other');
            if (!category) return;
            
            const price = parseFloat(prompt('Price (₦):', '0'));
            if (isNaN(price) || price <= 0) {
                showMessage('Invalid price', 'error');
                return;
            }
            
            const stock = parseInt(prompt('Initial stock:', '0'));
            if (isNaN(stock) || stock < 0) {
                showMessage('Invalid stock', 'error');
                return;
            }
            
            const newId = products.length > 0 ? Math.max(...products.map(p => p.id)) + 1 : 1;
            
            products.push({
                id: newId,
                name: name,
                category: category,
                price: price,
                stock: stock,
                sold: 0
            });
            
            saveProducts();
            loadProductsTable();
            loadDashboard();
            updateHeaderStats();
            
            showMessage(`"${name}" added`, 'success');
        }

        function editProduct(productId) {
            const product = products.find(p => p.id === productId);
            if (!product) return;
            
            const newName = prompt('New name:', product.name);
            if (!newName) return;
            
            const newCategory = prompt('New category:', product.category);
            if (!newCategory) return;
            
            const newPrice = parseFloat(prompt('New price:', product.price.toString()));
            if (isNaN(newPrice) || newPrice <= 0) {
                showMessage('Invalid price', 'error');
                return;
            }
            
            const newStock = parseInt(prompt('New stock:', product.stock.toString()));
            if (isNaN(newStock) || newStock < 0) {
                showMessage('Invalid stock', 'error');
                return;
            }
            
            product.name = newName;
            product.category = newCategory;
            product.price = newPrice;
            product.stock = newStock;
            
            saveProducts();
            loadProductsTable();
            loadDashboard();
            updateHeaderStats();
            loadPosProducts();
            
            showMessage(`"${newName}" updated`, 'success');
        }

        function deleteProduct(productId) {
            const product = products.find(p => p.id === productId);
            if (!product) return;
            
            if (!confirm(`Delete "${product.name}"?`)) return;
            
            products = products.filter(p => p.id !== productId);
            cart = cart.filter(item => item.productId !== productId);
            
            saveProducts();
            saveCart();
            loadProductsTable();
            loadDashboard();
            updateHeaderStats();
            loadPosProducts();
            updateCartDisplay();
            
            showMessage(`"${product.name}" deleted`, 'success');
        }

        function exportProducts() {
            const exportData = {
                products: products,
                exported: new Date().toISOString()
            };
            
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(exportData, null, 2));
            const downloadAnchor = document.createElement('a');
            downloadAnchor.setAttribute("href", dataStr);
            downloadAnchor.setAttribute("download", "philomath_products.json");
            downloadAnchor.click();
            
            showMessage('Products exported', 'success');
        }

        // ===== POS SYSTEM =====
        function loadPosProducts() {
            const posList = document.getElementById('posProductsList');
            posList.innerHTML = '';
            
            products.forEach(product => {
                const posProduct = document.createElement('div');
                posProduct.className = 'pos-product';
                posProduct.onclick = () => addToCart(product.id);
                posProduct.innerHTML = `
                    <div class="product-img-small">
                        <i class="fas fa-box"></i>
                    </div>
                    <h4>${product.name}</h4>
                    <div style="color:#4f46e5; font-weight:700; font-size:1.1rem; margin-bottom:5px;">${settings.currency}${product.price.toLocaleString()}</div>
                    <div style="font-size:0.85rem; color:#64748b; margin-bottom:10px;">
                        ${product.stock === 0 ? 
                            '<span style="color:#ef4444;">Out of Stock</span>' : 
                            `Stock: ${product.stock}`
                        }
                    </div>
                `;
                posList.appendChild(posProduct);
            });
        }

        function addToCart(productId) {
            const product = products.find(p => p.id === productId);
            if (!product || product.stock === 0) {
                showMessage('Out of stock!', 'error');
                return;
            }
            
            const existingItem = cart.find(item => item.productId === productId);
            if (existingItem) {
                if (existingItem.quantity < product.stock) {
                    existingItem.quantity++;
                } else {
                    showMessage(`Only ${product.stock} available!`, 'error');
                    return;
                }
            } else {
                cart.push({
                    productId: productId,
                    name: product.name,
                    price: product.price,
                    quantity: 1
                });
            }
            
            updateCartDisplay();
            saveCart();
            showMessage(`${product.name} added`, 'success');
        }

        function updateCartDisplay() {
            const cartItems = document.getElementById('cartItems');
            const cartTotal = document.getElementById('cartTotal');
            const cartItemCount = document.getElementById('cartItemCount');
            
            if (cart.length === 0) {
                cartItems.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #94a3b8;">
                        <i class="fas fa-shopping-cart" style="font-size: 3rem; opacity: 0.3; margin-bottom: 15px;"></i>
                        <p>No items in cart</p>
                        <p style="font-size: 0.9rem; margin-top: 10px;">Add products from the left</p>
                    </div>
                `;
                cartTotal.textContent = '0.00';
                cartItemCount.textContent = '0';
                return;
            }
            
            let itemsHTML = '';
            let total = 0;
            let itemCount = 0;
            
            cart.forEach((item, index) => {
                const product = products.find(p => p.id === item.productId);
                const itemTotal = item.price * item.quantity;
                total += itemTotal;
                itemCount += item.quantity;
                
                itemsHTML += `
                    <div class="cart-item">
                        <div>
                            <h4>${item.name}</h4>
                            <div style="color:#64748b; font-size:0.9rem;">${settings.currency}${item.price.toLocaleString()} each</div>
                        </div>
                        <div class="cart-item-actions">
                            <button class="quantity-btn" onclick="changeCartQuantity(${index}, -1)">-</button>
                            <span style="min-width:30px; text-align:center; font-weight:600;">${item.quantity}</span>
                            <button class="quantity-btn" onclick="changeCartQuantity(${index}, 1)">+</button>
                        </div>
                        <div style="font-weight:700; color:#4f46e5; min-width:80px; text-align:right;">
                            ${settings.currency}${itemTotal.toLocaleString()}
                        </div>
                    </div>
                `;
            });
            
            cartItems.innerHTML = itemsHTML;
            cartTotal.textContent = total.toLocaleString('en-US', { minimumFractionDigits: 2 });
            cartItemCount.textContent = itemCount;
        }

        function changeCartQuantity(index, change) {
            const item = cart[index];
            const product = products.find(p => p.id === item.productId);
            
            if (!product) return;
            
            const newQuantity = item.quantity + change;
            
            if (newQuantity < 1) {
                cart.splice(index, 1);
            } else if (newQuantity <= product.stock) {
                item.quantity = newQuantity;
            } else {
                showMessage(`Only ${product.stock} available!`, 'error');
                return;
            }
            
            updateCartDisplay();
            saveCart();
        }

        function clearCart() {
            if (cart.length === 0) {
                showMessage('Cart is empty', 'error');
                return;
            }
            
            if (confirm('Clear cart?')) {
                cart = [];
                updateCartDisplay();
                saveCart();
                showMessage('Cart cleared', 'success');
            }
        }

        function checkout() {
            if (cart.length === 0) {
                showMessage('Cart is empty', 'error');
                return;
            }
            
            // Check stock
            for (const item of cart) {
                const product = products.find(p => p.id === item.productId);
                if (!product || product.stock < item.quantity) {
                    showMessage(`Not enough ${item.name}!`, 'error');
                    return;
                }
            }
            
            const total = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            const tax = settings.taxRate ? (total * settings.taxRate) / 100 : 0;
            const grandTotal = total + tax;
            
            if (!confirm(`Checkout for ${settings.currency}${grandTotal.toLocaleString()}?`)) {
                return;
            }
            
            // Generate receipt number
            const receiptNumber = 'PM' + Date.now().toString().slice(-8);
            
            // Create sale
            const sale = {
                id: sales.length + 1,
                receiptNumber: receiptNumber,
                date: new Date().toISOString(),
                items: cart.map(item => ({
                    productId: item.productId,
                    name: item.name,
                    price: item.price,
                    quantity: item.quantity,
                    total: item.price * item.quantity
                })),
                subtotal: total,
                tax: tax,
                total: grandTotal,
                paymentMethod: 'cash',
                cashier: currentUser.name
            };
            
            // Update stock
            cart.forEach(item => {
                const product = products.find(p => p.id === item.productId);
                if (product) {
                    product.stock -= item.quantity;
                    product.sold = (product.sold || 0) + item.quantity;
                }
            });
            
            // Save sale
            sales.push(sale);
            
            // Save data
            saveProducts();
            saveSales();
            
            // Clear cart
            cart = [];
            saveCart();
            updateCartDisplay();
            
            // Generate receipt
            generateReceipt(sale);
            
            // Update UI
            loadDashboard();
            updateHeaderStats();
            loadPosProducts();
            
            showMessage(`Sale completed! #${receiptNumber}`, 'success');
        }

        function generateReceipt(sale) {
            const receiptContainer = document.getElementById('receiptContainer');
            const saleDate = new Date(sale.date);
            
            let receiptHTML = `
                <div style="text-align: center; margin-bottom: 25px; border-bottom: 2px solid #e2e8f0; padding-bottom: 20px;">
                    <div style="font-size: 2rem; font-weight: 800; color: #4f46e5; margin-bottom: 5px;">${settings.storeName}</div>
                    <div style="color:#64748b; margin:5px 0;">${settings.storeAddress}</div>
                    <div style="color:#64748b; margin-bottom:15px;">${settings.storePhone}</div>
                    <div style="font-size: 1.5rem; color: #334155; margin-bottom: 10px;">SALES RECEIPT</div>
                </div>
                
                <div style="display: flex; justify-content: space-between; margin-bottom: 20px; font-size: 0.95rem; color: #64748b;">
                    <div>
                        <div><strong>Receipt #:</strong> ${sale.receiptNumber}</div>
                        <div><strong>Date:</strong> ${saleDate.toLocaleDateString()}</div>
                        <div><strong>Time:</strong> ${saleDate.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</div>
                    </div>
                    <div>
                        <div><strong>Cashier:</strong> ${sale.cashier}</div>
                        <div><strong>Items:</strong> ${sale.items.reduce((sum, item) => sum + item.quantity, 0)}</div>
                    </div>
                </div>
                
                <div style="margin: 20px 0;">
            `;
            
            sale.items.forEach(item => {
                receiptHTML += `
                    <div style="display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid #f1f5f9; font-size: 1rem;">
                        <div>
                            <div style="font-weight:500;">${item.name}</div>
                            <div style="font-size:0.9rem; color:#64748b;">
                                ${settings.currency}${item.price.toLocaleString()} × ${item.quantity}
                            </div>
                        </div>
                        <div style="font-weight:600;">
                            ${settings.currency}${item.total.toLocaleString()}
                        </div>
                    </div>
                `;
            });
            
            receiptHTML += `
                </div>
                
                <div style="margin-top: 25px; padding-top: 20px; border-top: 2px solid #e2e8f0;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 10px; font-size: 1.1rem;">
                        <span>Subtotal:</span>
                        <span>${settings.currency}${sale.subtotal.toLocaleString()}</span>
                    </div>
                    ${sale.tax > 0 ? `
                        <div style="display: flex; justify-content: space-between; margin-bottom: 10px; font-size: 1.1rem;">
                            <span>Tax (${settings.taxRate}%):</span>
                            <span>${settings.currency}${sale.tax.toLocaleString()}</span>
                        </div>
                    ` : ''}
                    <div style="display: flex; justify-content: space-between; font-weight: 800; font-size: 1.5rem; color: #4f46e5; margin-top: 15px; padding-top: 15px; border-top: 2px solid #e2e8f0;">
                        <span>TOTAL:</span>
                        <span>${settings.currency}${sale.total.toLocaleString()}</span>
                    </div>
                </div>
                
                <div style="text-align: center; margin-top: 30px; color: #64748b; font-size: 0.9rem;">
                    <p>${settings.receiptFooter}</p>
                    <p style="margin-top:10px;">Powered by Philomath Mini Mart System</p>
                </div>
                
                <div style="display: flex; gap: 15px; margin-top: 25px;">
                    <button onclick="printReceipt()" style="flex:1; padding:15px; border:none; border-radius:10px; font-size:1rem; font-weight:600; cursor:pointer; display:flex; align-items:center; justify-content:center; gap:10px; background:linear-gradient(90deg, #3b82f6, #2563eb); color:white;">
                        <i class="fas fa-print"></i> Print Receipt
                    </button>
                    <button onclick="newSale()" style="flex:1; padding:15px; border:none; border-radius:10px; font-size:1rem; font-weight:600; cursor:pointer; display:flex; align-items:center; justify-content:center; gap:10px; background:#e2e8f0; color:#475569;">
                        <i class="fas fa-plus"></i> New Sale
                    </button>
                </div>
            `;
            
            receiptContainer.innerHTML = receiptHTML;
            receiptContainer.classList.add('active');
        }

        function printReceipt() {
            const receiptContent = document.getElementById('receiptContainer').innerHTML;
            const originalContent = document.body.innerHTML;
            
            document.body.innerHTML = receiptContent;
            window.print();
            document.body.innerHTML = originalContent;
            
            // Reload to restore functionality
            setTimeout(() => {
                window.location.reload();
            }, 100);
        }

        function newSale() {
            document.getElementById('receiptContainer').classList.remove('active');
            showMessage('Ready for new sale', 'info');
        }

        // ===== SALES HISTORY =====
        function loadSales() {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            
            let filteredSales = sales;
            
            if (startDate && endDate) {
                filteredSales = sales.filter(sale => {
                    const saleDate = new Date(sale.date).toISOString().split('T')[0];
                    return saleDate >= startDate && saleDate <= endDate;
                });
            }
            
            // Update summary
            const salesCount = filteredSales.length;
            const totalRevenue = filteredSales.reduce((sum, sale) => sum + sale.total, 0);
            const avgSale = salesCount > 0 ? Math.round(totalRevenue / salesCount) : 0;
            
            // Find top product
            const productSales = {};
            filteredSales.forEach(sale => {
                sale.items.forEach(item => {
                    productSales[item.name] = (productSales[item.name] || 0) + item.quantity;
                });
            });
            
            let topProduct = '-';
            let maxSales = 0;
            Object.entries(productSales).forEach(([product, quantity]) => {
                if (quantity > maxSales) {
                    maxSales = quantity;
                    topProduct = product;
                }
            });
            
            // Update display
            document.getElementById('filteredSalesCount').textContent = salesCount;
            document.getElementById('filteredRevenue').textContent = formatNumber(totalRevenue);
            document.getElementById('filteredAvg').textContent = formatNumber(avgSale);
            document.getElementById('topProduct').textContent = topProduct;
            
            // Update table
            const salesTable = document.getElementById('salesTable');
            salesTable.innerHTML = '';
            
            if (filteredSales.length === 0) {
                salesTable.innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align: center; padding: 40px; color: #64748b;">
                            <i class="fas fa-chart-bar" style="font-size: 2rem; margin-bottom: 10px; opacity: 0.5;"></i>
                            <p>No sales found</p>
                        </td>
                    </tr>
                `;
                return;
            }
            
            filteredSales.reverse().forEach(sale => {
                const saleDate = new Date(sale.date);
                const totalItems = sale.items.reduce((sum, item) => sum + item.quantity, 0);
                const itemsList = sale.items.map(item => `${item.name} (x${item.quantity})`).join(', ');
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><strong>${sale.receiptNumber}</strong></td>
                    <td>${saleDate.toLocaleDateString()} ${saleDate.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</td>
                    <td>${itemsList}</td>
                    <td>${totalItems}</td>
                    <td><strong>${settings.currency}${sale.total.toLocaleString()}</strong></td>
                    <td><span style="background:#d1fae5; color:#065f46; padding:4px 10px; border-radius:12px; font-size:0.85rem;">${sale.paymentMethod}</span></td>
                    <td>
                        <button onclick="viewSale(${sale.id})" style="padding:6px 12px; background:#3b82f6; color:white; border:none; border-radius:6px; cursor:pointer;">
                            <i class="fas fa-eye"></i> View
                        </button>
                    </td>
                `;
                salesTable.appendChild(row);
            });
        }

        function filterSales() {
            loadSales();
        }

        function resetSalesFilter() {
            setupDateFilters();
            loadSales();
        }

        function viewSale(saleId) {
            const sale = sales.find(s => s.id === saleId);
            if (!sale) return;
            
            generateReceipt(sale);
            switchTab('pos');
            showMessage(`Viewing receipt #${sale.receiptNumber}`, 'info');
        }

        // ===== SETTINGS =====
        function loadSettings() {
            document.getElementById('storeName').value = settings.storeName;
            document.getElementById('storeAddress').value = settings.storeAddress;
            document.getElementById('storePhone').value = settings.storePhone;
            document.getElementById('storeCurrency').value = settings.currency;
            document.getElementById('receiptFooter').value = settings.receiptFooter;
            document.getElementById('taxRate').value = settings.taxRate;
            
            // Save on change
            document.querySelectorAll('#accountForm input, #accountForm select, #receiptForm input').forEach(el => {
                el.addEventListener('change', saveSettings);
            });
        }

        function saveSettings() {
            settings.storeName = document.getElementById('storeName').value;
            settings.storeAddress = document.getElementById('storeAddress').value;
            settings.storePhone = document.getElementById('storePhone').value;
            settings.currency = document.getElementById('storeCurrency').value;
            settings.receiptFooter = document.getElementById('receiptFooter').value;
            settings.taxRate = parseFloat(document.getElementById('taxRate').value) || 0;
            
            localStorage.setItem(STORAGE_KEYS.SETTINGS, JSON.stringify(settings));
            
            // Update UI
            document.querySelectorAll('.store-name-header').forEach(el => {
                el.textContent = settings.storeName;
            });
            
            showMessage('Settings saved', 'success');
        }

        function exportAllData() {
            const allData = {
                users: users,
                products: products,
                sales: sales,
                settings: settings,
                exported: new Date().toISOString()
            };
            
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(allData, null, 2));
            const downloadAnchor = document.createElement('a');
            downloadAnchor.setAttribute("href", dataStr);
            downloadAnchor.setAttribute("download", "philomath_backup.json");
            downloadAnchor.click();
            
            showMessage('All data exported', 'success');
        }

        function backupData() {
            localStorage.setItem('philomath_last_backup', new Date().toISOString());
            showMessage('Backup created', 'success');
        }

        // ===== UTILITY FUNCTIONS =====
        function saveProducts() {
            localStorage.setItem(STORAGE_KEYS.PRODUCTS, JSON.stringify(products));
        }

        function saveSales() {
            localStorage.setItem(STORAGE_KEYS.SALES, JSON.stringify(sales));
        }

        function saveCart() {
            localStorage.setItem(STORAGE_KEYS.CART, JSON.stringify(cart));
        }

        function formatNumber(num) {
            return num.toLocaleString('en-US');
        }

        function showMessage(text, type) {
            // Remove existing
            const existing = document.querySelectorAll('.message');
            existing.forEach(msg => msg.remove());
            
            // Create new
            const message = document.createElement('div');
            message.className = `message ${type}`;
            message.innerHTML = `
                <i class="fas ${type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-exclamation-circle' : 'fa-info-circle'}"></i>
                <span>${text}</span>
            `;
            
            document.body.appendChild(message);
            
            // Remove after 3 seconds
            setTimeout(() => {
                if (message.parentNode) {
                    message.remove();
                }
            }, 3000);
        }

        // Make functions global
        window.showForgotPassword = showForgotPassword;
        window.closeForgotPassword = closeForgotPassword;
        window.sendResetLink = sendResetLink;
        window.showResetPassword = showResetPassword;
        window.closeResetPassword = closeResetPassword;
        window.resetPassword = resetPassword;
        window.switchTab = switchTab;
        window.refreshDashboard = refreshDashboard;
        window.exportProducts = exportProducts;
        window.showAddProduct = showAddProduct;
        window.editProduct = editProduct;
        window.deleteProduct = deleteProduct;
        window.addToCart = addToCart;
        window.changeCartQuantity = changeCartQuantity;
        window.clearCart = clearCart;
        window.checkout = checkout;
        window.printReceipt = printReceipt;
        window.newSale = newSale;
        window.filterSales = filterSales;
        window.resetSalesFilter = resetSalesFilter;
        window.viewSale = viewSale;
        window.exportAllData = exportAllData;
        window.backupData = backupData;
        window.logout = logout;
    </script>
</body>
</html>
